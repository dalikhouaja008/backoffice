<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DocuSign Authentification</title>
  <script>
    function log(message, isError) {
      console.log(message);
      var logElement = document.getElementById('logs');
      if (logElement) {
        var entry = document.createElement('div');
        entry.textContent = new Date().toLocaleTimeString() + ": " + message;
        if (isError) {
          entry.style.color = 'red';
        }
        logElement.appendChild(entry);
      }
    }

    // Fonction pour récupérer les paramètres de l'URL
    function getUrlParams() {
      var params = {};
      var queryString = window.location.search.substring(1);
      var pairs = queryString.split('&');
      
      for (var i = 0; i < pairs.length; i++) {
        var pair = pairs[i].split('=');
        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
      }
      
      return params;
    }

    // Échange le code contre un token
    async function exchangeCodeForToken(code) {
      try {
        log("Échange du code contre un token...");
        
        // Préparer les données pour la requête
        const clientId = "d956403b-d435-4cca-9763-53489f61dd6c";
        const clientSecret = "35df48ab-cf3e-4803-9da0-2b38435467e2"; // Normalement, vous ne devriez pas exposer le secret client côté client
        const redirectUri = "http://localhost:8080/callback.html";
        
        // Construire les données du formulaire
        const formData = new URLSearchParams();
        formData.append('grant_type', 'authorization_code');
        formData.append('code', code);
        formData.append('client_id', clientId);
        formData.append('client_secret', clientSecret);
        formData.append('redirect_uri', redirectUri);
        
        // Effectuer la requête
        const response = await fetch('https://account-d.docusign.com/oauth/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: formData
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          log("Erreur lors de l'échange: " + response.status + " - " + errorText, true);
          return null;
        }
        
        const data = await response.json();
        log("Token récupéré avec succès");
        return data;
      } catch (e) {
        log("Erreur lors de l'échange du code: " + e, true);
        return null;
      }
    }

    window.onload = async function() {
      log("Page de callback chargée at " + new Date().toLocaleString());
      log("URL complète: " + window.location.href);
      
      // Récupérer les paramètres de l'URL
      const params = getUrlParams();
      
      if (params.code) {
        log("Code d'autorisation trouvé: " + params.code);
        
        // Échanger le code contre un token
        const tokenData = await exchangeCodeForToken(params.code);
        
        if (tokenData && tokenData.access_token) {
          try {
            // Stocker le token dans localStorage
            window.localStorage.setItem('docusign_token', tokenData.access_token);
            log("Token stocké dans localStorage");
            
            // Stocker l'expiration
            const expiresIn = tokenData.expires_in || 3600;
            const expiryTime = new Date().getTime() + (expiresIn * 1000);
            window.localStorage.setItem('docusign_token_expiry', expiryTime.toString());
            log("Expiration stockée: " + new Date(expiryTime).toLocaleString());
            
            // Vérifier que le token est bien stocké
            const storedToken = window.localStorage.getItem('docusign_token');
            if (storedToken) {
              log("Vérification du stockage: OK (token présent)");
              document.getElementById('status').innerText = 'Authentification réussie! Fermeture...';
              document.getElementById('status').style.color = 'green';
              
              // Essayer de communiquer avec la fenêtre parente
              if (window.opener) {
                try {
                  log("Tentative d'envoi du message à la fenêtre parente...");
                  window.opener.postMessage({
                    type: 'docusign_auth_success',
                    token: tokenData.access_token
                  }, '*');
                  log("Message envoyé à la fenêtre parente");
                } catch (e) {
                  log("Erreur lors de l'envoi du message à la fenêtre parente: " + e, true);
                }
              } else {
                log("Pas de fenêtre parente détectée", true);
              }
              
              // Fermer cette fenêtre après un délai
              setTimeout(function() {
                window.close();
              }, 3000);
            } else {
              log("ERREUR: Le token est absent du localStorage après stockage", true);
            }
          } catch (e) {
            log("ERREUR lors du stockage: " + e, true);
          }
        } else {
          log("Échec de l'échange du code contre un token", true);
          document.getElementById('status').innerText = 'Erreur lors de l\'échange du code';
          document.getElementById('status').style.color = 'red';
        }
      } else {
        log("Pas de code d'autorisation trouvé dans l'URL", true);
        document.getElementById('status').innerText = 'Erreur: Aucun code reçu';
        document.getElementById('status').style.color = 'red';
      }
    };
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
      padding: 0 20px;
    }
    #status {
      font-size: 18px;
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #logs {
      margin-top: 30px;
      border: 1px solid #ccc;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      text-align: left;
      font-family: monospace;
      font-size: 12px;
      background-color: #f5f5f5;
    }
    .log-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h2>DocuSign Authentication</h2>
  <div id="status">Traitement de l'authentification...</div>
  <button onclick="window.close()">Fermer cette fenêtre</button>
  <button onclick="window.localStorage.removeItem('docusign_token'); window.localStorage.removeItem('docusign_token_expiry'); alert('Tokens supprimés!');">Effacer les tokens</button>
  
  <div class="log-title">Logs de débogage:</div>
  <div id="logs"><!-- Les logs seront ajoutés ici --></div>
</body>
</html>